# 機能仕様書: Excel から PDF への変換 API サービス

**機能ブランチ**: `001-excel-pdf-api`  
**作成日**: 2025-12-29  
**ステータス**: ドラフト  
**入力**: ユーザー説明: "Excel から PDF への変換 REST API サービスの追加"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 基本的な Excel から PDF への変換 (優先度: P1)

ユーザーまたはアプリケーションが、閲覧、アーカイブ、または配布目的で Excel ファイルを PDF 形式に変換する必要があります。ユーザーは API エンドポイントを通じて Excel ファイルをアップロードし、元のコンテンツ構造を保持した PDF バージョンを受け取ります。

**この優先度の理由**: これはサービスの核となる機能です。これがなければ、サービスは何の価値も提供しません。他のすべての機能は、この基本的な機能の上に構築されます。

**独立したテスト**: 基本的なデータ（セル内のテキストと数値）を含むシンプルな Excel ファイルを API 経由でアップロードし、コンテンツがそのまま保持された読みやすい PDF が返されることを確認することで、完全にテストできます。

**受け入れシナリオ**:

1. **前提条件** 有効な Excel ファイル（.xlsx または .xls 形式）がある、**操作** ユーザーが変換エンドポイントにファイルをアップロードする、**期待結果** システムが Excel ファイルのすべての可視コンテンツを含む PDF ファイルを返す
2. **前提条件** 複数シートの Excel ワークブックがある、**操作** ユーザーがファイルをアップロードする、**期待結果** システムがすべてのシートを明確なシート分離を持って PDF に変換する
3. **前提条件** 表と書式設定を含む Excel ファイルがある、**操作** 変換が完了する、**期待結果** PDF が表構造、罫線、テキストの配置を可能な限り保持する
4. **前提条件** 複数の行と列を持つ Excel ファイルがある、**操作** PDF に変換される、**期待結果** コンテンツが適切な改ページで PDF ページに収まる

---

### ユーザーストーリー 2 - エラー処理とステータスフィードバック (優先度: P2)

ユーザーとアプリケーションは、変換が失敗したとき、または無効なファイルが送信されたときに明確なフィードバックが必要です。これにより、何が問題なのかを推測することなくトラブルシューティングできます。

**この優先度の理由**: P1 が正常系を処理する一方で、実際の使用には堅牢なエラー処理が必要です。これは本番環境での使用には不可欠ですが、コア変換機能が動作した後に開発できます。

**独立したテスト**: さまざまな無効な入力（間違ったファイル形式、破損したファイル、サイズ超過ファイル）を送信し、適切なエラーメッセージが返されることを確認することで、完全にテストできます。

**受け入れシナリオ**:

1. **前提条件** Excel 以外のファイル（例: .txt、.png）がある、**操作** 変換エンドポイントにアップロードする、**期待結果** システムがサポートされていないファイル形式を示す明確なエラーメッセージを返す
2. **前提条件** 破損した Excel ファイルがある、**操作** 変換のために送信する、**期待結果** システムが適切なステータスコードとともにファイルが処理できないことを示すエラーを返す
3. **前提条件** 有効な Excel ファイルがある、**操作** 内部エラーにより変換が失敗する、**期待結果** システムが内部実装の詳細を公開せずにエラーレスポンスを返す
4. **前提条件** サイズ超過の Excel ファイルがある、**操作** アップロードする、**期待結果** システムが許可される最大サイズとともにファイルサイズ制限を超えたことを示すエラーを返す

---

### ユーザーストーリー 3 - API 統合の準備 (優先度: P3)

フロントエンドアプリケーションと他のサービスは、一貫した API レスポンス形式、適切な HTTP ステータスコード、およびドキュメントを必要とし、変換 API とスムーズに統合する必要があります。

**この優先度の理由**: 統合には重要ですが、コア機能とエラー処理が機能した後に洗練できます。これにより、API が本番環境に対応し、REST のベストプラクティスに従うことが保証されます。

**独立したテスト**: さまざまなシナリオで API エンドポイントを呼び出し、レスポンス形式の一貫性、ステータスコード、およびヘッダーが REST API 標準に適していることを確認することで、完全にテストできます。

**受け入れシナリオ**:

1. **前提条件** 任意の API リクエストがある、**操作** 処理される、**期待結果** レスポンスが適切な HTTP ステータスコードを持つ一貫した JSON 構造に従う
2. **前提条件** 変換が成功した、**操作** PDF が返される、**期待結果** 適切なヘッダー（Content-Type、Content-Disposition など）が設定される
3. **前提条件** 複数の同時リクエストがある、**操作** 処理される、**期待結果** 各リクエストが状態の干渉なしに独立して処理される
4. **前提条件** API エンドポイントのドキュメントがある、**操作** 開発者がそれに従う、**期待結果** 追加サポートなしで正常に統合できる

---

### エッジケース

- Excel ファイルにデータがないか、空のシートのみが含まれている場合はどうなりますか？
- システムは非常に幅の広い表（100列以上）を含む Excel ファイルをどのように処理しますか？
- Excel ファイルに特殊文字、非ラテン文字、または絵文字が含まれている場合はどうなりますか？
- システムは数式を含む Excel ファイルをどのように処理しますか - 計算値または数式を表示して変換されますか？
- Excel ファイルサイズが妥当な制限に近づくか超える場合はどうなりますか？
- システムはパスワード保護された、または暗号化された Excel ファイルをどのように処理しますか？

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、ファイルアップロード経由で .xlsx および .xls 形式の Excel ファイルを受け入れなければならない
- **FR-002**: システムは、アップロードされた Excel ファイルを PDF 形式に変換しなければならない
- **FR-003**: システムは、変換された PDF で表構造、セルコンテンツ、および基本的な書式設定（罫線、配置）を保持しなければならない
- **FR-004**: システムは、すべてのシートを変換することで、複数シートの Excel ワークブックを処理しなければならない
- **FR-005**: システムは、変換された PDF ファイルをリクエストしているクライアントに返さなければならない
- **FR-006**: システムは、処理前にアップロードされたファイル形式を検証しなければならない
- **FR-007**: システムは、無効なファイル形式に対して明確なエラーメッセージを返さなければならない
- **FR-008**: システムは、破損または処理不可能なファイルに対して明確なエラーメッセージを返さなければならない
- **FR-009**: システムは、ファイルサイズ制限を処理し、超過時に適切なエラーを返さなければならない
- **FR-010**: システムは、セッション状態を維持せずに各リクエストを独立して処理しなければならない
- **FR-011**: システムは、標準的な HTTP メソッドとステータスコードに従う REST API エンドポイントを提供しなければならない
- **FR-012**: システムは、一時ファイルストレージを安全に処理し、変換後にクリーンアップしなければならない
- **FR-013**: システムは、他のドキュメント形式（Word、画像）の将来の拡張性をサポートしなければならない
- **FR-014**: システムは、10MB のファイルサイズ制限を適用しなければならない

### 主要なエンティティ

- **変換リクエスト**: Excel から PDF への単一の変換操作を表し、ソースファイル、変換ステータス、および結果を含む
- **Excel ドキュメント**: 変換されるシート、セル、書式設定、およびデータを含む入力ドキュメント
- **PDF 出力**: Excel ソースからコンテンツと構造を保持する生成されたドキュメント
- **エラーレスポンス**: エラータイプ、メッセージ、およびガイダンスを含む失敗に関する構造化された情報

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは、標準的な Excel ファイル（5MB未満、10シート未満）を30秒以内に PDF に変換できる
- **SC-002**: システムは、一般的な Excel ファイルのバリエーションの95%を最初の試行で正しく変換する
  - **一般的なバリエーションの定義**: 50行×20列以内、5シート以内、基本書式のみ（罫線、配置、フォント、背景色）、数式は計算値として表示、マクロなし、画像・グラフなし
- **SC-003**: 変換された PDF は、ソース Excel ファイルからの可視書式設定と構造の90%を保持する
  - **保持対象の書式要素**: 罫線（スタイル、色）、テキスト配置（水平・垂直）、フォント（名前、サイズ、太字、斜体、色）、背景色、セル結合、表構造
  - **測定方法**: テストケースごとに目視確認で書式要素の保持率を評価（10要素中9要素以上保持で合格）
- **SC-004**: API は、無効な入力の100%に対して2秒以内に適切なエラーメッセージを返す
- **SC-005**: システムは、妥当な制限まで劣化なしに複数の同時変換リクエストを処理する
- **SC-006**: 変換リクエスト間でデータ漏洩がゼロ（完全なステートレス操作）
- **SC-007**: API エンドポイントは、一般的な開発者が1週間以内にフロントエンド統合を可能にする REST 規約に従う

## 前提条件 *(オプション)*

- アップロードされる Excel ファイルは、複雑な視覚化ではなく、主にビジネスドキュメント（スプレッドシート、レポート、表）である
- フェーズ1では、デフォルトのファイルサイズ制限10MBが許容される（明確化に基づいて調整可能）
- ユーザーは、ほぼ瞬時の処理ではなく、妥当な変換時間（1分未満）を期待する
- サービスは最終的にクラウド環境にデプロイされるが、開発用にローカルで動作する必要がある
- サービスは最初は信頼できるクライアントによって使用される（認証/認可は外部で処理される）
- 処理には一時ファイルストレージが許容される（フェーズ1ではメモリのみの処理は不要）

## 依存関係 *(オプション)*

- Excel ファイル解析機能（.xlsx および .xls 形式を読み取る能力）
- PDF 生成機能（プログラムで PDF ドキュメントを作成する能力）
- ファイルアップロード処理メカニズム
- 自動クリーンアップ機能付き一時ファイルストレージ

## スコープの境界 *(オプション)*

### スコープ内

- Excel（.xlsx、.xls）ファイルの PDF への変換
- ファイルアップロードと PDF ダウンロードのための REST API
- エラー処理と検証
- 複数シートワークブックのサポート
- 基本的な書式設定の保持（表、罫線、テキスト）
- ステートレス操作
- ローカル開発環境のセットアップ

### スコープ外（フェーズ1）

- ユーザー認証と認可
- クラウドインフラのデプロイ（サーバー、Terraform、クラウド構成）
- 他のドキュメント形式の変換（Word、PowerPoint、画像） - 将来のフェーズ
- 複雑な Excel 機能（グラフ、ピボットテーブル、マクロ、VBA）
- 複数ファイルのバッチ処理
- 変換履歴またはロギング
- 変換中のリアルタイム進捗更新
- 高度な PDF 機能（ブックマーク、ハイパーリンク、注釈）
- PDF での Excel 数式の保持（数式は計算値として表示される）
- パスワード保護された Excel ファイルのサポート

## 将来の検討事項 *(オプション)*

- Word ドキュメントから PDF への変換のサポート
- 画像から PDF への変換のサポート
- PowerPoint から PDF への変換のサポート
- バッチ変換 API（1つのリクエストで複数ファイル）
- 変換オプション/設定（ページサイズ、向き、スケーリング）
- 長時間実行される変換のための Webhook 通知
- クラウドデプロイ構成
- ユーザー認証とレート制限
- 変換履歴と監査ログ
- 高度な Excel 機能のサポート（Excel に埋め込まれたグラフ、画像）
